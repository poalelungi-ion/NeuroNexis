
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>NEURONEXIS AI Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <style>
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .typing-indicator { display: flex; padding: 8px 12px; }
    .typing-dot { width: 8px; height: 8px; margin: 0 2px; background: #4b5563; border-radius: 50%; animation: pulse 1.5s infinite ease-in-out; }
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.3s; }
    .typing-dot:nth-child(3) { animation-delay: 0.6s; }
    .chat-container { height: calc(100vh - 180px); }
    .message-animation { animation: messageAppear 0.3s ease-out; }
    @keyframes messageAppear { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .xai-explanation { border-left: 3px solid #6366f1; transition: all 0.3s ease; }
    .xai-explanation:hover { background: #f8fafc; }
    .dark .xai-explanation:hover { background: #1e293b; }
    .sidebar { transition: transform 0.3s ease; }
    .dark .bg-gray-100 { background: #1f2937; }
    @media (max-width: 640px) {
      .chat-container { height: calc(100vh - 220px); }
      .container { padding: 0.5rem; }
      .g_id_signin { width: 100%; }
      .sidebar { width: 100%; z-index: 50; }
      textarea { font-size: 14px; padding: 10px; }
      .max-w-md { max-width: 100%; }
      .p-4 { padding: 1rem; }
      .text-2xl { font-size: 1.5rem; }
      .rounded-lg { border-radius: 0.5rem; }
    }
    @media (max-width: 768px) {
      .chat-container { height: calc(100vh - 200px); }
      .container { padding: 1rem; }
      .g_id_signin { width: 100%; }
    }
    textarea:focus { box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); }
    button:focus { outline: none; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
<div class="container mx-auto max-w-6xl px-4 py-6">
  <!-- Login Section -->
  <div id="login-section" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 max-w-md mx-auto my-12 text-center">
    <h2 class="text-2xl font-bold mb-6" data-translate="welcome">Welcome to NEURONEXIS AI</h2>
    <div id="g_id_onload" data-client_id="906465572275-hanrq89dvi0a8bpf2benqdq7quu3njtc.apps.googleusercontent.com" data-context="signin" data-ux_mode="popup" data-callback="handleGoogleSignIn" data-auto_prompt="false"></div>
    <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-text="signin_with" data-size="large" data-logo_alignment="left" data-width="300"></div>
    <div class="mt-6 text-sm text-gray-500 dark:text-gray-400" data-translate="terms">By signing in, you agree to our Terms.</div>
    <button id="try-without-login" class="mt-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition" data-translate="try_without_login">Try Without Login</button>
  </div>

  <!-- Main App -->
  <div id="app-content" class="hidden">
    <header class="flex justify-between items-center mb-6">
      <div class="flex items-center space-x-2">
        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-600 to-blue-500 flex items-center justify-center text-white font-bold text-xl">N</div>
        <h1 class="text-2xl font-bold">NEURONEXIS</h1>
      </div>
      <div class="flex items-center space-x-4">
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
          <i class="fas fa-moon dark:hidden"></i>
          <i class="fas fa-sun hidden dark:block"></i>
        </button>
        <button id="profile-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
          <i class="fas fa-user"></i>
        </button>
      </div>
    </header>

    <div class="flex">
      <div class="w-full">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
          <div class="border-b border-gray-200 dark:border-gray-700 p-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
              <div class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-blue-400"></div>
              <h2 class="font-semibold" data-translate="chat_title">NEURONEXIS Chat</h2>
            </div>
            <button id="toggle-sidebar-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
              <i class="fas fa-bars"></i>
            </button>
          </div>
          <div class="chat-container overflow-y-auto p-4 space-y-4" id="chat-box"></div>
          <div class="border-t border-gray-200 dark:border-gray-700 p-4">
            <div class="flex items-center space-x-2">
              <button id="document-creation" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="Create Document">
                <i class="fas fa-file-word"></i>
              </button>
              <div class="flex-grow relative">
                <textarea id="user-input" rows="1" class="w-full border border-gray-300 dark:border-gray-600 rounded-full py-3 px-4 pr-12 focus:outline-none focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 resize-none" placeholder="Message NEURONEXIS..." data-translate-placeholder="message_placeholder"></textarea>
                <button id="send-btn" class="absolute right-3 top-1/2 transform -translate-y-1/2 p-1 rounded-full text-gray-500 hover:text-purple-600 dark:hover:text-purple-400">
                  <i class="fas fa-paper-plane text-xl"></i>
                </button>
              </div>
              <button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                <i class="fas fa-microphone"></i>
              </button>
            </div>
            <div class="flex justify-between items-center mt-2 px-2">
              <div class="text-xs text-gray-500 dark:text-gray-400" data-translate="disclaimer">NEURONEXIS may produce inaccurate info</div>
              <button id="xai-toggle" class="text-xs bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 px-2 py-1 rounded-full flex items-center space-x-1">
                <i class="fas fa-brain"></i><span data-translate="xai_mode">XAI Mode: On</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="sidebar" class="fixed top-0 right-0 w-64 h-full bg-gray-100 dark:bg-gray-800 shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out z-50 p-4">
        <h3 class="text-lg font-semibold mb-4" data-translate="settings">Settings</h3>
        <select id="lang-select" class="w-full p-2 mb-4 bg-white dark:bg-gray-700 rounded">
          <option value="en">English</option>
          <option value="es">Spanish</option>
          <option value="ro">Romanian</option>
          <option value="ru">Russian</option>
          <option value="fr">French</option>
        </select>
        <div id="login-nav" class="mb-4">
          <button id="login-btn" class="w-full p-2 bg-blue-500 text-white rounded hover:bg-blue-600" data-translate="login">Login</button>
        </div>
        <div id="profile-nav" class="hidden mb-4">
          <p id="user-name" class="mb-2"></p>
          <input id="instagram" class="w-full p-2 mb-2 bg-white dark:bg-gray-700 rounded" placeholder="Instagram Handle" data-translate-placeholder="instagram_placeholder">
          <input id="facebook" class="w-full p-2 mb-2 bg-white dark:bg-gray-700 rounded" placeholder="Facebook Name" data-translate-placeholder="facebook_placeholder">
          <button id="logout-btn" class="w-full p-2 bg-red-500 text-white rounded hover:bg-red-600" data-translate="logout">Logout</button>
        </div>
        <div class="mt-4">
          <label class="block mb-2" data-translate="upload_file">Upload File</label>
          <input type="file" id="file-input" class="w-full p-2 bg-white dark:bg-gray-700 rounded">
        </div>
        <div id="dialog-menu" class="mt-4">
          <select id="dialog-select" class="w-full p-2 bg-white dark:bg-gray-700 rounded">
            <option value="default">Default</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Document Modal -->
    <div id="document-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold" data-translate="document_editor">Document Editor</h3>
          <button id="close-document-modal" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="document-content" class="flex-1 border border-gray-300 dark:border-gray-600 p-4 mb-4 overflow-y-auto"></div>
        <div class="flex space-x-2">
          <select id="document-type" class="bg-gray-100 dark:bg-gray-700 rounded-lg px-3 py-2">
            <option value="docx">Word Document</option>
            <option value="pdf">PDF</option>
            <option value="txt">Text File</option>
          </select>
          <button id="download-document" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700" data-translate="download">Download</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Split API keys
    const CLIENT_ID_PART1 = '906465572275';
    const CLIENT_ID_PART2 = '-hanrq89dvi0a8bpf2benqdq7quu3njtc';
    const CLIENT_ID = CLIENT_ID_PART1 + CLIENT_ID_PART2 + '.apps.googleusercontent.com';
    const API_KEY_PART1 = 'AIzaSyAlh';
    const API_KEY_PART2 = 'ppnqppicbPMfMz8R5H';
    const API_KEY_PART3 = 'ug3k9i1OTeWw';
    const API_KEY = API_KEY_PART1 + API_KEY_PART2 + API_KEY_PART3;
    const XAI_API_KEY_PART1 = 'xai-cvFdnRUdc4nScFMSg7AMh';
    const XAI_API_KEY_PART2 = 'mmODsOVzpC';
    const XAI_API_KEY_PART3 = 'gPGP1xT9AZA8RLNMDjRVkuTYuzrhMoC6tChxA7WWnNvXT4RJ4';
    const XAI_API_KEY = XAI_API_KEY_PART1 + XAI_API_KEY_PART2 + XAI_API_KEY_PART3;
    const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/calendar';

    let currentUser = localStorage.getItem('currentUser');
    let currentDialog = localStorage.getItem('currentDialog') || 'default';
    let chatHistory = JSON.parse(localStorage.getItem('userData'))?.[currentUser]?.chats?.[currentDialog] || [];
    let accessToken = localStorage.getItem('googleAccessToken');
    let userData = JSON.parse(localStorage.getItem('userData')) || {};
    let userLocation = null;
    let userLocationName = localStorage.getItem('userLocationName') || 'Unknown';
    let gapiInited = false;
    let gisInited = false;
    let instagram = localStorage.getItem('instagram') || '';
    let facebook = localStorage.getItem('facebook') || '';
    let xaiMode = true;
    let currentLanguage = localStorage.getItem('language') || 'en';

    const translations = {
      en: {
        welcome: 'Welcome to NEURONEXIS AI',
        terms: 'By signing in, you agree to our Terms.',
        try_without_login: 'Try Without Login',
        chat_title: 'NEURONEXIS Chat',
        message_placeholder: 'Message NEURONEXIS...',
        disclaimer: 'NEURONEXIS may produce inaccurate info',
        xai_mode: 'XAI Mode: On',
        xai_mode_off: 'XAI Mode: Off',
        settings: 'Settings',
        login: 'Login',
        logout: 'Logout',
        instagram_placeholder: 'Instagram Handle',
        facebook_placeholder: 'Facebook Name',
        upload_file: 'Upload File',
        document_editor: 'Document Editor',
        download: 'Download',
        guest_user: 'Guest User',
        logged_out: 'You have been logged out.',
        explanation: 'Explanation',
        explanation_response: 'Response crafted based on your input and location.',
        connection_error: 'Sorry, I couldn’t connect. Based on your location {location}, how can I help?',
        api_failed: 'API failed; using local logic with coordinates.',
        status_response: 'I\'m running smoothly! Ready to assist from your area.',
        status_check: ' You checked my status, so I confirmed my readiness.',
        uploaded: 'Uploaded',
        location_unknown: 'Location unknown. Please enable location services or provide your city/country. How can I assist?',
        where_am_i: 'I cannot determine your exact location without geolocation access. Please enable location services or provide your city/country.',
        located_near: 'Located near',
        coordinates: 'Coordinates: ({lat}, {lng})',
        how_can_i_help: 'How can I assist?',
        location_error: 'Unable to access location. Please enable location services or try again later.',
        login_error: 'Failed to load chat. Please check your connection or try again.'
      },
      ro: {
        welcome: 'Bun venit la NEURONEXIS AI',
        terms: 'Prin autentificare, sunteți de acord cu Termenii noștri.',
        try_without_login: 'Încearcă fără autentificare',
        chat_title: 'Chat NEURONEXIS',
        message_placeholder: 'Mesaj către NEURONEXIS...',
        disclaimer: 'NEURONEXIS poate produce informații inexacte',
        xai_mode: 'Mod XAI: Activat',
        xai_mode_off: 'Mod XAI: Dezactivat',
        settings: 'Setări',
        login: 'Autentificare',
        logout: 'Deconectare',
        instagram_placeholder: 'Nume Instagram',
        facebook_placeholder: 'Nume Facebook',
        upload_file: 'Încarcă fișier',
        document_editor: 'Editor de documente',
        download: 'Descarcă',
        guest_user: 'Utilizator invitat',
        logged_out: 'Ați fost deconectat.',
        explanation: 'Explicație',
        explanation_response: 'Răspuns creat pe baza inputului și locației tale.',
        connection_error: 'Îmi pare rău, nu m-am putut conecta. În funcție de locația ta {location}, ce mai pot face pentru tine?',
        api_failed: 'API a eșuat; folosesc logica locală cu coordonate.',
        status_response: 'Funcționez fără probleme! Gata să te ajut din zona ta.',
        status_check: ' Ai verificat starea mea, așa că am confirmat disponibilitatea.',
        uploaded: 'Încărcat',
        location_unknown: 'Locație necunoscută. Te rog să activezi serviciile de localizare sau să indici orașul/țara. Cum te pot ajuta?',
        where_am_i: 'Nu pot determina locația ta exactă fără acces la geolocalizare. Te rog să activezi serviciile de localizare sau să indici orașul/țara.',
        located_near: 'Situat în apropiere de',
        coordinates: 'Coordonate: ({lat}, {lng})',
        how_can_i_help: 'Cum te pot ajuta?',
        location_error: 'Nu pot accesa locația. Te rog să activezi serviciile de localizare sau să încerci din nou mai târziu.',
        login_error: 'Nu s-a putut încărca chatul. Verifică conexiunea sau încearcă din nou.'
      },
      ru: {
        welcome: 'Добро пожаловать в NEURONEXIS AI',
        terms: 'Входя в систему, вы соглашаетесь с нашими Условиями.',
        try_without_login: 'Попробовать без входа',
        chat_title: 'Чат NEURONEXIS',
        message_placeholder: 'Сообщение для NEURONEXIS...',
        disclaimer: 'NEURONEXIS может предоставлять неточную информацию',
        xai_mode: 'Режим XAI: Включен',
        xai_mode_off: 'Режим XAI: Выключен',
        settings: 'Настройки',
        login: 'Войти',
        logout: 'Выйти',
        instagram_placeholder: 'Имя в Instagram',
        facebook_placeholder: 'Имя в Facebook',
        upload_file: 'Загрузить файл',
        document_editor: 'Редактор документов',
        download: 'Скачать',
        guest_user: 'Гость',
        logged_out: 'Вы вышли из системы.',
        explanation: 'Объяснение',
        explanation_response: 'Ответ сформирован на основе вашего ввода и местоположения.',
        connection_error: 'Извините, не удалось подключиться. Как могу помочь, учитывая ваше местоположение {location}?',
        api_failed: 'API не работает; использую локальную логику с координатами.',
        status_response: 'Я работаю без сбоев! Готов помочь из вашего региона.',
        status_check: ' Вы проверили мой статус, поэтому я подтвердил готовность.',
        uploaded: 'Загружено',
        location_unknown: 'Местоположение неизвестно. Пожалуйста, включите службы геолокации или укажите ваш город/страну. Как могу помочь?',
        where_am_i: 'Я не могу определить ваше точное местоположение без доступа к геолокации. Пожалуйста, включите службы геолокации или укажите ваш город/страну.',
        located_near: 'Находится рядом с',
        coordinates: 'Координаты: ({lat}, {lng})',
        how_can_i_help: 'Как могу помочь?',
        location_error: 'Не удалось получить доступ к местоположению. Пожалуйста, включите службы геолокации или попробуйте снова позже.',
        login_error: 'Не удалось загрузить чат. Проверьте подключение или попробуйте снова.'
      },
      fr: {
        welcome: 'Bienvenue sur NEURONEXIS AI',
        terms: 'En vous connectant, vous acceptez nos conditions.',
        try_without_login: 'Essayer sans connexion',
        chat_title: 'Chat NEURONEXIS',
        message_placeholder: 'Message à NEURONEXIS...',
        disclaimer: 'NEURONEXIS peut produire des informations inexactes',
        xai_mode: 'Mode XAI : Activé',
        xai_mode_off: 'Mode XAI : Désactivé',
        settings: 'Paramètres',
        login: 'Connexion',
        logout: 'Déconnexion',
        instagram_placeholder: 'Identifiant Instagram',
        facebook_placeholder: 'Nom Facebook',
        upload_file: 'Télécharger un fichier',
        document_editor: 'Éditeur de documents',
        download: 'Télécharger',
        guest_user: 'Utilisateur invité',
        logged_out: 'Vous avez été déconnecté.',
        explanation: 'Explication',
        explanation_response: 'Réponse élaborée en fonction de votre saisie et de votre emplacement.',
        connection_error: 'Désolé, je n’ai pas pu me connecter. En fonction de votre emplacement {location}, comment puis-je vous aider ?',
        api_failed: 'L’API a échoué ; j’utilise une logique locale avec les coordonnées.',
        status_response: 'Je fonctionne parfaitement ! Prêt à vous aider depuis votre région.',
        status_check: ' Vous avez vérifié mon statut, j’ai donc confirmé ma disponibilité.',
        uploaded: 'Téléchargé',
        location_unknown: 'Emplacement inconnu. Veuillez activer les services de localisation ou indiquer votre ville/pays. Comment puis-je vous aider ?',
        where_am_i: 'Je ne peux pas déterminer votre emplacement exact sans accès à la géolocalisation. Veuillez activer les services de localisation ou indiquer votre ville/pays.',
        located_near: 'Situé près de',
        coordinates: 'Coordonnées : ({lat}, {lng})',
        how_can_i_help: 'Comment puis-je vous aider ?',
        location_error: 'Impossible d’accéder à l’emplacement. Veuillez activer les services de localisation ou réessayer plus tard.',
        login_error: 'Impossible de charger le chat. Vérifiez votre connexion ou réessayez.'
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      const chatBox = document.getElementById('chat-box');
      const userInput = document.getElementById('user-input');
      const sendBtn = document.getElementById('send-btn');
      const sidebar = document.getElementById('sidebar');
      const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
      const langSelect = document.getElementById('lang-select');
      const loginNav = document.getElementById('login-nav');
      const profileNav = document.getElementById('profile-nav');
      const profileBtn = document.getElementById('profile-btn');
      const userName = document.getElementById('user-name');
      const fileInput = document.getElementById('file-input');
      const documentModal = document.getElementById('document-modal');
      const documentContent = document.getElementById('document-content');
      const closeDocumentModal = document.getElementById('close-document-modal');
      const documentType = document.getElementById('document-type');
      const downloadDocument = document.getElementById('download-document');
      const xaiToggle = document.getElementById('xai-toggle');
      const instagramInput = document.getElementById('instagram');
      const facebookInput = document.getElementById('facebook');
      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');

      // Google API Initialization
      function gapiLoaded() {
        try {
          gapi.load('client', initializeGapiClient);
        } catch (error) {
          console.error('gapi.load failed:', error);
          gapiInited = true; // Proceed even if gapi fails
          maybeEnableApp();
        }
      }

      async function initializeGapiClient() {
        try {
          await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: [
              'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
              'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'
            ]
          });
          console.log('Google API initialized');
          gapiInited = true;
          maybeEnableApp();
        } catch (error) {
          console.error('Google API initialization error:', error);
          gapiInited = true; // Proceed to avoid blocking
          maybeEnableApp();
        }
      }

      function gisLoaded() {
        console.log('Google Sign-In script loaded');
        gisInited = true;
        maybeEnableApp();
      }

      function maybeEnableApp() {
        if (currentUser) {
          console.log('User detected, enabling app:', currentUser);
          document.getElementById('login-section').classList.add('hidden');
          document.getElementById('app-content').classList.remove('hidden');
          updateUI();
          loadUserData(); // Load location data after showing UI
        } else {
          console.log('No user detected, showing login section');
          document.getElementById('login-section').classList.remove('hidden');
          document.getElementById('app-content').classList.add('hidden');
        }
      }

      window.gapiLoaded = gapiLoaded;
      window.gisLoaded = gisLoaded;

      function handleGoogleSignIn(response) {
        try {
          const userInfo = JSON.parse(atob(response.credential.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
          currentUser = userInfo.email;
          accessToken = response.credential;
          localStorage.setItem('currentUser', currentUser);
          localStorage.setItem('googleAccessToken', accessToken);
          userData[currentUser] = userData[currentUser] || { chats: {}, instagram: '', facebook: '' };
          localStorage.setItem('userData', JSON.stringify(userData));
          console.log('Google Sign-In successful:', currentUser);
          maybeEnableApp();
        } catch (error) {
          console.error('Google Sign-In error:', error);
          addMessage(translations[currentLanguage].login_error, 'ai');
        }
      }

      async function loadUserData() {
        // Check for cached location
        const cachedLocation = JSON.parse(localStorage.getItem('userLocation'));
        if (cachedLocation && Date.now() - cachedLocation.timestamp < 3600000) { // 1 hour cache
          userLocation = cachedLocation.coords;
          userLocationName = cachedLocation.name || translations[currentLanguage].coordinates.replace('{lat}', userLocation.lat).replace('{lng}', userLocation.lng);
          console.log('Using cached location:', userLocationName, userLocation);
          addMessage(
                  `${translations[currentLanguage].welcome}! ${translations[currentLanguage].located_near} ${userLocationName}. ${translations[currentLanguage].how_can_i_help} ${instagram ? `Instagram: ${instagram}` : ''} ${facebook ? `Facebook: ${facebook}` : ''}`,
                  'ai'
          );
        } else if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
                  async (pos) => {
                    userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    console.log('Geolocation success:', userLocation);
                    try {
                      userLocationName = await fetchLocationNameWithRetry(userLocation);
                      console.log('Reverse geocoding success:', userLocationName);
                    } catch (error) {
                      console.warn('Reverse geocoding failed, using coordinates:', error);
                      userLocationName = translations[currentLanguage].coordinates.replace('{lat}', userLocation.lat).replace('{lng}', userLocation.lng);
                    }
                    localStorage.setItem('userLocation', JSON.stringify({
                      coords: userLocation,
                      name: userLocationName,
                      timestamp: Date.now()
                    }));
                    localStorage.setItem('userLocationName', userLocationName);
                    addMessage(
                            `${translations[currentLanguage].welcome}! ${translations[currentLanguage].located_near} ${userLocationName}. ${translations[currentLanguage].how_can_i_help} ${instagram ? `Instagram: ${instagram}` : ''} ${facebook ? `Facebook: ${facebook}` : ''}`,
                            'ai'
                    );
                  },
                  (err) => {
                    console.error('Geolocation error:', err.message, err.code);
                    userLocationName = 'Unknown';
                    localStorage.setItem('userLocationName', userLocationName);
                    addMessage(
                            `${translations[currentLanguage].welcome}! ${translations[currentLanguage].location_unknown} ${instagram ? `Instagram: ${instagram}` : ''} ${facebook ? `Facebook: ${facebook}` : ''}`,
                            'ai'
                    );
                  },
                  { timeout: 10000, maximumAge: 60000, enableHighAccuracy: true }
          );
        } else {
          console.warn('Geolocation not supported');
          userLocationName = 'Unknown';
          localStorage.setItem('userLocationName', userLocationName);
          addMessage(
                  `${translations[currentLanguage].welcome}! ${translations[currentLanguage].location_unknown} ${instagram ? `Instagram: ${instagram}` : ''} ${facebook ? `Facebook: ${facebook}` : ''}`,
                  'ai'
          );
        }
        if (userData[currentUser]) {
          instagram = userData[currentUser].instagram || '';
          facebook = userData[currentUser].facebook || '';
          instagramInput.value = instagram;
          facebookInput.value = facebook;
          userName.textContent = currentUser === 'guest@neuronexis.com' ? translations[currentLanguage].guest_user : (userData[currentUser]?.name || currentUser);
          chatHistory.forEach(msg => addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai'));
        }
        updateTranslations();
      }

      async function fetchLocationNameWithRetry(location, retries = 3, delay = 1000) {
        for (let i = 0; i < retries; i++) {
          try {
            const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${location.lat}&lon=${location.lng}&zoom=10&addressdetails=1`,
                    { headers: { 'User-Agent': 'NEURONEXIS_AI/1.0' } }
            );
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return data.display_name || translations[currentLanguage].coordinates.replace('{lat}', location.lat).replace('{lng}', location.lng);
          } catch (error) {
            console.warn(`Reverse geocoding attempt ${i + 1} failed:`, error);
            if (i < retries - 1) await new Promise(resolve => setTimeout(resolve, delay));
            else return translations[currentLanguage].coordinates.replace('{lat}', location.lat).replace('{lng}', location.lng);
          }
        }
      }

      function updateUI() {
        loginNav.classList.add('hidden');
        profileNav.classList.remove('hidden');
        userName.textContent = currentUser === 'guest@neuronexis.com' ? translations[currentLanguage].guest_user : (userData[currentUser]?.name || currentUser);
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('app-content').classList.remove('hidden');
        const avatar = document.createElement('div');
        avatar.className = 'w-8 h-8 rounded-full bg-cover bg-center';
        avatar.style.backgroundImage = `url(https://via.placeholder.com/150)`;
        document.querySelector('header').prepend(avatar);
        updateTranslations();
      }

      function updateTranslations() {
        document.querySelectorAll('[data-translate]').forEach(element => {
          const key = element.getAttribute('data-translate');
          if (translations[currentLanguage][key]) {
            element.textContent = translations[currentLanguage][key];
          }
        });
        document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
          const key = element.getAttribute('data-translate-placeholder');
          if (translations[currentLanguage][key]) {
            element.placeholder = translations[currentLanguage][key];
          }
        });
        xaiToggle.innerHTML = xaiMode
                ? `<i class="fas fa-brain"></i><span>${translations[currentLanguage].xai_mode}</span>`
                : `<i class="fas fa-brain"></i><span>${translations[currentLanguage].xai_mode_off}</span>`;
      }

      document.getElementById('try-without-login').addEventListener('click', () => {
        try {
          currentUser = 'guest@neuronexis.com';
          userData[currentUser] = userData[currentUser] || { chats: {}, instagram: '', facebook: '' };
          localStorage.setItem('currentUser', currentUser);
          localStorage.setItem('userData', JSON.stringify(userData));
          console.log('Try Without Login clicked, user set:', currentUser);
          maybeEnableApp();
        } catch (error) {
          console.error('Try Without Login error:', error);
          addMessage(translations[currentLanguage].login_error, 'ai');
        }
      });

      loginBtn.addEventListener('click', () => {
        try {
          google.accounts.id.prompt();
          console.log('Login button clicked, prompting Google Sign-In');
        } catch (error) {
          console.error('Google Sign-In prompt error:', error);
          addMessage(translations[currentLanguage].login_error, 'ai');
        }
      });

      logoutBtn.addEventListener('click', () => {
        currentUser = null;
        accessToken = null;
        localStorage.removeItem('currentUser');
        localStorage.removeItem('googleAccessToken');
        localStorage.removeItem('userLocation');
        localStorage.removeItem('userLocationName');
        loginNav.classList.remove('hidden');
        profileNav.classList.add('hidden');
        chatBox.innerHTML = '';
        document.getElementById('login-section').classList.remove('hidden');
        document.getElementById('app-content').classList.add('hidden');
        addMessage(translations[currentLanguage].logged_out, 'ai');
      });

      document.getElementById('theme-toggle').addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
      });

      if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      }

      toggleSidebarBtn.addEventListener('click', () => {
        sidebar.classList.toggle('translate-x-full');
        sidebar.classList.toggle('translate-x-0');
      });

      profileBtn.addEventListener('click', () => {
        sidebar.classList.toggle('translate-x-full');
        sidebar.classList.toggle('translate-x-0');
      });

      langSelect.addEventListener('change', e => {
        currentLanguage = e.target.value;
        localStorage.setItem('language', currentLanguage);
        updateTranslations();
      });

      userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
      });

      userInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      sendBtn.addEventListener('click', sendMessage);

      xaiToggle.addEventListener('click', () => {
        xaiMode = !xaiMode;
        xaiToggle.innerHTML = xaiMode
                ? `<i class="fas fa-brain"></i><span>${translations[currentLanguage].xai_mode}</span>`
                : `<i class="fas fa-brain"></i><span>${translations[currentLanguage].xai_mode_off}</span>`;
        xaiToggle.classList.toggle('bg-purple-100', xaiMode);
        xaiToggle.classList.toggle('dark:bg-purple-900', xaiMode);
        xaiToggle.classList.toggle('bg-gray-200', !xaiMode);
        xaiToggle.classList.toggle('dark:bg-gray-700', !xaiMode);
      });

      instagramInput.addEventListener('change', e => {
        instagram = e.target.value;
        userData[currentUser].instagram = instagram;
        localStorage.setItem('userData', JSON.stringify(userData));
      });

      facebookInput.addEventListener('change', e => {
        facebook = e.target.value;
        userData[currentUser].facebook = facebook;
        localStorage.setItem('userData', JSON.stringify(userData));
      });

      function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        addMessage(message, 'user');
        userInput.value = '';
        userInput.style.height = 'auto';

        showTypingIndicator();

        setTimeout(async () => {
          removeTypingIndicator();
          const aiResponse = await generateAIResponse(message);
          addMessage(aiResponse.response, 'ai');
          if (xaiMode && aiResponse.explanation) {
            setTimeout(() => addMessage(aiResponse.explanation, 'ai', true), 500);
          }
          chatHistory.push({ role: 'user', content: message, timestamp: new Date().toISOString() });
          chatHistory.push({ role: 'ai', content: aiResponse.response, timestamp: new Date().toISOString() });
          userData[currentUser] = userData[currentUser] || { chats: {}, instagram, facebook };
          userData[currentUser].chats[currentDialog] = chatHistory;
          localStorage.setItem('userData', JSON.stringify(userData));
        }, 1500 + Math.random() * 2000);
      }

      function addMessage(text, sender, isExplanation = false) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('flex', 'message-animation');
        if (sender === 'user') {
          messageDiv.classList.add('justify-end');
          messageDiv.innerHTML = `<div class="max-w-[80%] bg-purple-600 text-white rounded-lg p-3 shadow-md"><p>${text}</p></div>`;
        } else {
          messageDiv.classList.add('justify-start');
          messageDiv.innerHTML = isExplanation
                  ? `
              <div class="max-w-[80%] bg-gray-100 dark:bg-gray-700 rounded-lg p-3 shadow-md xai-explanation">
                <div class="flex items-start space-x-2">
                  <div class="w-6 h-6 rounded-full bg-gradient-to-r from-purple-500 to-blue-400 mt-1 flex items-center justify-center text-white text-xs">N</div>
                  <div><p class="font-semibold text-purple-600 dark:text-purple-400" data-translate="explanation">${translations[currentLanguage].explanation}</p><p>${text}</p></div>
                </div>
              </div>`
                  : `
              <div class="max-w-[80%] bg-gray-100 dark:bg-gray-700 rounded-lg p-3 shadow-md">
                <div class="flex items-start space-x-2">
                  <div class="w-6 h-6 rounded-full bg-gradient-to-r from-purple-500 to-blue-400 mt-1"></div>
                  <div><p class="font-semibold">NEURONEXIS AI</p><p>${text}</p></div>
                </div>
              </div>`;
        }
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.classList.add('flex', 'justify-start');
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = `
          <div class="max-w-[80%] bg-gray-100 dark:bg-gray-700 rounded-lg p-2 shadow-md">
            <div class="flex items-center space-x-2 pl-2">
              <div class="w-6 h-6 rounded-full bg-gradient-to-r from-purple-500 to-blue-400"></div>
              <div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>
            </div>
          </div>`;
        chatBox.appendChild(typingDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function removeTypingIndicator() {
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) typingIndicator.remove();
      }

      async function generateAIResponse(userMessage) {
        const locationQueries = {
          en: ['where am i', 'my location', 'where i am'],
          ro: ['unde ma aflu', 'locația mea', 'unde sunt'],
          ru: ['где я нахожусь', 'мое местоположение', 'где я'],
          fr: ['où suis-je', 'mon emplacement', 'où je suis']
        };
        const isLocationQuery = Object.values(locationQueries).flat().some(query => userMessage.toLowerCase().includes(query));

        if (isLocationQuery) {
          if (userLocation) {
            try {
              userLocationName = await fetchLocationNameWithRetry(userLocation);
              console.log('Location query success:', userLocationName);
              localStorage.setItem('userLocation', JSON.stringify({
                coords: userLocation,
                name: userLocationName,
                timestamp: Date.now()
              }));
              localStorage.setItem('userLocationName', userLocationName);
              return {
                response: `${translations[currentLanguage].located_near} ${userLocationName}. ${translations[currentLanguage].how_can_i_help} ${instagram ? `Instagram: ${instagram}` : ''} ${facebook ? `Facebook: ${facebook}` : ''}`,
                explanation: translations[currentLanguage].explanation_response
              };
            } catch (error) {
              console.warn('Location query failed:', error);
              userLocationName = translations[currentLanguage].coordinates.replace('{lat}', userLocation.lat).replace('{lng}', userLocation.lng);
              localStorage.setItem('userLocationName', userLocationName);
              return {
                response: `${translations[currentLanguage].where_am_i} ${translations[currentLanguage].coordinates.replace('{lat}', userLocation.lat).replace('{lng}', userLocation.lng)}.`,
                explanation: translations[currentLanguage].api_failed
              };
            }
          } else {
            return {
              response: translations[currentLanguage].where_am_i,
              explanation: translations[currentLanguage].location_error
            };
          }
        }

        const statusQueries = {
          en: ['how are you', 'how you doing'],
          ro: ['ce mai faci', 'ce mai faci tu'],
          ru: ['как дела', 'как ты'],
          fr: ['comment vas-tu', 'ça va']
        };
        const isStatusQuery = Object.values(statusQueries).flat().some(query => userMessage.toLowerCase().includes(query));

        try {
          const response = await fetch('https://api.x.ai/v1/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${XAI_API_KEY}` },
            body: JSON.stringify({
              model: 'grok-3',
              messages: [
                {
                  role: 'system',
                  content: `You are NEURONEXIS AI. Language: ${currentLanguage}. Use location: ${userLocation ? translations[currentLanguage].coordinates.replace('{lat}', userLocation.lat).replace('{lng}', userLocation.lng) : userLocationName}. Include Instagram: ${instagram}, Facebook: ${facebook} in responses if relevant.`
                },
                { role: 'user', content: userMessage }
              ],
              temperature: 0.7,
              max_tokens: 4000
            })
          });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          const fullResponse = data.choices[0].message.content;
          let explanation = xaiMode ? translations[currentLanguage].explanation_response : '';
          return { response: fullResponse, explanation };
        } catch (error) {
          console.error('xAI API Error:', error);
          let response = translations[currentLanguage].connection_error.replace('{location}', userLocation ? translations[currentLanguage].coordinates.replace('{lat}', userLocation.lat).replace('{lng}', userLocation.lng) : userLocationName);
          let explanation = translations[currentLanguage].api_failed;
          if (isStatusQuery) {
            response = translations[currentLanguage].status_response;
            explanation += translations[currentLanguage].status_check;
          }
          return { response, explanation };
        }
      }

      document.getElementById('document-creation').addEventListener('click', () => {
        documentModal.classList.remove('hidden');
        documentContent.textContent = `Location: ${userLocationName}\nCoordinates: ${userLocation ? `(${userLocation.lat}, ${userLocation.lng})` : 'Unknown'}\nInstagram: ${instagram}\nFacebook: ${facebook}\n\nAdd your message here...`;
      });

      closeDocumentModal.addEventListener('click', () => documentModal.classList.add('hidden'));

      downloadDocument.addEventListener('click', () => {
        const content = documentContent.textContent;
        const type = documentType.value;
        const blob = new Blob([content], { type: type === 'docx' ? 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' : type === 'pdf' ? 'application/pdf' : 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `document.${type}`;
        a.click();
        URL.revokeObjectURL(url);
        documentModal.classList.add('hidden');
      });

      fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = event => addMessage(`${translations[currentLanguage].uploaded}: ${event.target.result.substring(0, 100)}${event.target.result.length > 100 ? '...' : ''}`, 'ai');
          reader.readAsText(file);
        }
      });

      const dialogSelect = document.getElementById('dialog-select');
      dialogSelect.addEventListener('change', e => {
        currentDialog = e.target.value;
        localStorage.setItem('currentDialog', currentDialog);
        chatHistory = userData[currentUser]?.chats?.[currentDialog] || [];
        chatBox.innerHTML = '';
        chatHistory.forEach(msg => addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai'));
      });

      // Initialize app if user exists
      if (currentUser) {
        console.log('Initial user check:', currentUser);
        maybeEnableApp();
      }

      // Timeout for Google API initialization to prevent indefinite wait
      setTimeout(() => {
        if (!gapiInited || !gisInited) {
          console.warn('Google API initialization timed out, proceeding with app');
          gapiInited = true;
          gisInited = true;
          maybeEnableApp();
        }
      }, 10000); // 10-second timeout
    });
  </script>
</body>
</html>
