<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>NEURONEXIS AI Chat with Google Calendar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <style>
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .typing-indicator { display: flex; padding: 8px 12px; }
    .typing-dot { width: 8px; height: 8px; margin: 0 2px; background: #4b5563; border-radius: 50%; animation: pulse 1.5s infinite ease-in-out; }
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.3s; }
    .typing-dot:nth-child(3) { animation-delay: 0.6s; }
    .chat-container { height: calc(100vh - 180px); }
    .message-animation { animation: messageAppear 0.3s ease-out; }
    @keyframes messageAppear { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .xai-explanation { border-left: 3px solid #6366f1; transition: all 0.3s ease; }
    .xai-explanation:hover { background: #f8fafc; }
    .dark .xai-explanation:hover { background: #1e293b; }
    .sidebar { transition: transform 0.3s ease; }
    .dark .bg-gray-100 { background: #1f2937; }
    .event-card {
      border-left: 4px solid #6366f1;
      transition: all 0.2s ease;
    }
    .event-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .calendar-icon {
      background: linear-gradient(135deg, #4285F4 0%, #34A853 50%, #FBBC05 100%);
    }
    @media (max-width: 640px) {
      .chat-container { height: calc(100vh - 220px); }
      .container { padding: 0.5rem; }
      .g_id_signin { width: 100%; }
      .sidebar { width: 100%; z-index: 50; }
      textarea { font-size: 14px; padding: 10px; }
      .max-w-md { max-width: 100%; }
      .p-4 { padding: 1rem; }
      .text-2xl { font-size: 1.5rem; }
      .rounded-lg { border-radius: 0.5rem; }
    }
    @media (max-width: 768px) {
      .chat-container { height: calc(100vh - 200px); }
      .container { padding: 1rem; }
      .g_id_signin { width: 100%; }
    }
    textarea:focus { box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); }
    button:focus { outline: none; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
<div class="container mx-auto max-w-6xl px-4 py-6">
  <!-- Login Section -->
  <div id="login-section" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 max-w-md mx-auto my-12 text-center">
    <h2 class="text-2xl font-bold mb-6" data-translate="welcome">Welcome to NEURONEXIS AI</h2>
    <div id="g_id_onload"
         data-client_id="906465572275-hanrq89dvi0a8bpf2benqdq7quu3njtc.apps.googleusercontent.com"
         data-context="signin"
         data-ux_mode="popup"
         data-callback="handleGoogleSignIn"
         data-auto_prompt="false"></div>
    <div class="g_id_signin"
         data-type="standard"
         data-shape="pill"
         data-theme="outline"
         data-text="signin_with"
         data-size="large"
         data-logo_alignment="left"
         data-width="300"></div>
    <div class="mt-6 text-sm text-gray-500 dark:text-gray-400" data-translate="terms">By signing in, you agree to our Terms.</div>
    <button id="try-without-login" class="mt-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition" data-translate="try_without_login">Try Without Login</button>
  </div>

  <!-- Main App -->
  <div id="app-content" class="hidden">
    <header class="flex justify-between items-center mb-6">
      <div class="flex items-center space-x-2">
        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-600 to-blue-500 flex items-center justify-center text-white font-bold text-xl">N</div>
        <h1 class="text-2xl font-bold">NEURONEXIS</h1>
      </div>
      <div class="flex items-center space-x-4">
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
          <i class="fas fa-moon dark:hidden"></i>
          <i class="fas fa-sun hidden dark:block"></i>
        </button>
        <button id="profile-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
          <i class="fas fa-user"></i>
        </button>
      </div>
    </header>

    <div class="flex">
      <div class="w-full">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
          <div class="border-b border-gray-200 dark:border-gray-700 p-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
              <div class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-blue-400"></div>
              <h2 class="font-semibold" data-translate="chat_title">NEURONEXIS Chat</h2>
            </div>
            <button id="toggle-sidebar-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
              <i class="fas fa-bars"></i>
            </button>
          </div>
          <div class="chat-container overflow-y-auto p-4 space-y-4" id="chat-box"></div>
          <div class="border-t border-gray-200 dark:border-gray-700 p-4">
            <div class="flex items-center space-x-2">
              <button id="document-creation" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="Create Document">
                <i class="fas fa-file-word"></i>
              </button>
              <button id="calendar-actions" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="Calendar Actions">
                <i class="fas fa-calendar-alt"></i>
              </button>
              <div class="flex-grow relative">
                <textarea id="user-input" rows="1" class="w-full border border-gray-300 dark:border-gray-600 rounded-full py-3 px-4 pr-12 focus:outline-none focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 resize-none" placeholder="Message NEURONEXIS..." data-translate-placeholder="message_placeholder"></textarea>
                <button id="send-btn" class="absolute right-3 top-1/2 transform -translate-y-1/2 p-1 rounded-full text-gray-500 hover:text-purple-600 dark:hover:text-purple-400">
                  <i class="fas fa-paper-plane text-xl"></i>
                </button>
              </div>
              <button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                <i class="fas fa-microphone"></i>
              </button>
            </div>
            <div class="flex justify-between items-center mt-2 px-2">
              <div class="text-xs text-gray-500 dark:text-gray-400" data-translate="disclaimer">NEURONEXIS may produce inaccurate info</div>
              <button id="xai-toggle" class="text-xs bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 px-2 py-1 rounded-full flex items-center space-x-1">
                <i class="fas fa-brain"></i><span data-translate="xai_mode">XAI Mode: On</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="sidebar" class="fixed top-0 right-0 w-64 h-full bg-gray-100 dark:bg-gray-800 shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out z-50 p-4">
        <h3 class="text-lg font-semibold mb-4" data-translate="settings">Settings</h3>
        <select id="lang-select" class="w-full p-2 mb-4 bg-white dark:bg-gray-700 rounded">
          <option value="en">English</option>
          <option value="es">Spanish</option>
          <option value="ro">Romanian</option>
          <option value="ru">Russian</option>
          <option value="fr">French</option>
        </select>
        <div id="login-nav" class="mb-4">
          <button id="login-btn" class="w-full p-2 bg-blue-500 text-white rounded hover:bg-blue-600" data-translate="login">Login</button>
        </div>
        <div id="profile-nav" class="hidden mb-4">
          <p id="user-name" class="mb-2"></p>
          <input id="instagram" class="w-full p-2 mb-2 bg-white dark:bg-gray-700 rounded" placeholder="Instagram Handle" data-translate-placeholder="instagram_placeholder">
          <input id="facebook" class="w-full p-2 mb-2 bg-white dark:bg-gray-700 rounded" placeholder="Facebook Name" data-translate-placeholder="facebook_placeholder">
          <button id="logout-btn" class="w-full p-2 bg-red-500 text-white rounded hover:bg-red-600" data-translate="logout">Logout</button>
        </div>
        <div class="mt-4">
          <label class="block mb-2" data-translate="upload_file">Upload File</label>
          <input type="file" id="file-input" class="w-full p-2 bg-white dark:bg-gray-700 rounded">
        </div>
        <div id="dialog-menu" class="mt-4">
          <select id="dialog-select" class="w-full p-2 bg-white dark:bg-gray-700 rounded">
            <option value="default">Default</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Document Modal -->
    <div id="document-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold" data-translate="document_editor">Document Editor</h3>
          <button id="close-document-modal" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="document-content" class="flex-1 border border-gray-300 dark:border-gray-600 p-4 mb-4 overflow-y-auto"></div>
        <div class="flex space-x-2">
          <select id="document-type" class="bg-gray-100 dark:bg-gray-700 rounded-lg px-3 py-2">
            <option value="docx">Word Document</option>
            <option value="pdf">PDF</option>
            <option value="txt">Text File</option>
          </select>
          <button id="download-document" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700" data-translate="download">Download</button>
        </div>
      </div>
    </div>

    <!-- Calendar Modal -->
    <div id="calendar-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold flex items-center space-x-2">
            <div class="calendar-icon w-8 h-8 rounded-full flex items-center justify-center text-white">
              <i class="fas fa-calendar-alt"></i>
            </div>
            <span data-translate="calendar_actions">Calendar Actions</span>
          </h3>
          <button id="close-calendar-modal" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <button id="list-events" class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg flex flex-col items-center">
              <i class="fas fa-list-ul text-2xl mb-2"></i>
              <span data-translate="list_events">List Events</span>
            </button>
            <button id="create-event" class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg flex flex-col items-center">
              <i class="fas fa-plus text-2xl mb-2"></i>
              <span data-translate="create_event">Create Event</span>
            </button>
            <button id="find-free-time" class="bg-yellow-500 hover:bg-yellow-600 text-white p-4 rounded-lg flex flex-col items-center">
              <i class="fas fa-clock text-2xl mb-2"></i>
              <span data-translate="find_free_time">Find Free Time</span>
            </button>
            <button id="calendar-settings" class="bg-purple-500 hover:bg-purple-600 text-white p-4 rounded-lg flex flex-col items-center">
              <i class="fas fa-cog text-2xl mb-2"></i>
              <span data-translate="calendar_settings">Calendar Settings</span>
            </button>
          </div>

          <!-- Event Creation Form -->
          <div id="event-creation-form" class="hidden mt-4 space-y-4">
            <div class="space-y-2">
              <label class="block" data-translate="event_title">Event Title</label>
              <input type="text" id="event-title" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-700">
            </div>
            <div class="space-y-2">
              <label class="block" data-translate="event_description">Description</label>
              <textarea id="event-description" rows="3" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-700"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div class="space-y-2">
                <label class="block" data-translate="start_time">Start Time</label>
                <input type="datetime-local" id="event-start" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-700">
              </div>
              <div class="space-y-2">
                <label class="block" data-translate="end_time">End Time</label>
                <input type="datetime-local" id="event-end" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-700">
              </div>
            </div>
            <div class="flex justify-end space-x-2">
              <button id="cancel-event" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded hover:bg-gray-400 dark:hover:bg-gray-500" data-translate="cancel">Cancel</button>
              <button id="submit-event" class="px-4 py-2 bg-green-500 rounded hover:bg-green-600 text-white" data-translate="create_event">Create Event</button>
            </div>
          </div>

          <!-- Events List -->
          <div id="events-list" class="hidden mt-4 space-y-3">
            <h4 class="font-semibold" data-translate="your_events">Your Upcoming Events</h4>
            <div id="events-container" class="space-y-2">
              <!-- Events will be populated here -->
            </div>
          </div>

          <!-- Free Time Finder -->
          <div id="free-time-finder" class="hidden mt-4 space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div class="space-y-2">
                <label class="block" data-translate="start_date">Start Date</label>
                <input type="date" id="free-time-start" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-700">
              </div>
              <div class="space-y-2">
                <label class="block" data-translate="end_date">End Date</label>
                <input type="date" id="free-time-end" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-700">
              </div>
            </div>
            <button id="find-free-slots" class="w-full py-2 bg-blue-500 rounded hover:bg-blue-600 text-white" data-translate="find_free_slots">Find Free Time Slots</button>
            <div id="free-time-results" class="hidden space-y-2">
              <h4 class="font-semibold" data-translate="available_slots">Available Time Slots</h4>
              <div id="free-time-container" class="space-y-2">
                <!-- Free time slots will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Split API keys
    const CLIENT_ID_PART1 = '906465572275';
    const CLIENT_ID_PART2 = '-hanrq89dvi0a8bpf2benqdq7quu3njtc';
    const CLIENT_ID = CLIENT_ID_PART1 + CLIENT_ID_PART2 + '.apps.googleusercontent.com';
    const API_KEY_PART1 = 'AIzaSyAlh';
    const API_KEY_PART2 = 'ppnqppicbPMfMz8R5H';
    const API_KEY_PART3 = 'ug3k9i1OTeWw';
    const API_KEY = API_KEY_PART1 + API_KEY_PART2 + API_KEY_PART3;
    const XAI_API_KEY_PART1 = 'xai-cvFdnRUdc4nScFMSg7AMh';
    const XAI_API_KEY_PART2 = 'mmODsOVzpC';
    const XAI_API_KEY_PART3 = 'gPGP1xT9AZA8RLNMDjRVkuTYuzrhMoC6tChxA7WWnNvXT4RJ4';
    const XAI_API_KEY = XAI_API_KEY_PART1 + XAI_API_KEY_PART2 + XAI_API_KEY_PART3;
    const SCOPES = 'https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/calendar.events';

    let currentUser = localStorage.getItem('currentUser');
    let currentDialog = localStorage.getItem('currentDialog') || 'default';
    let chatHistory = JSON.parse(localStorage.getItem('userData'))?.[currentUser]?.chats?.[currentDialog] || [];
    let accessToken = localStorage.getItem('googleAccessToken');
    let userData = JSON.parse(localStorage.getItem('userData')) || {};
    let userLocation = null;
    let userLocationName = localStorage.getItem('userLocationName') || 'Unknown';
    let gapiInited = false;
    let gisInited = false;
    let instagram = localStorage.getItem('instagram') || '';
    let facebook = localStorage.getItem('facebook') || '';
    let xaiMode = true;
    let currentLanguage = localStorage.getItem('language') || 'en';

    const translations = {
      en: {
        welcome: 'Welcome to NEURONEXIS AI',
        terms: 'By signing in, you agree to our Terms.',
        try_without_login: 'Try Without Login',
        chat_title: 'NEURONEXIS Chat',
        message_placeholder: 'Message NEURONEXIS...',
        disclaimer: 'NEURONEXIS may produce inaccurate info',
        xai_mode: 'XAI Mode: On',
        xai_mode_off: 'XAI Mode: Off',
        settings: 'Settings',
        login: 'Login',
        logout: 'Logout',
        instagram_placeholder: 'Instagram Handle',
        facebook_placeholder: 'Facebook Name',
        upload_file: 'Upload File',
        document_editor: 'Document Editor',
        download: 'Download',
        guest_user: 'Guest User',
        logged_out: 'You have been logged out.',
        explanation: 'Explanation',
        explanation_response: 'Response crafted based on your input and location.',
        connection_error: 'Sorry, I couldnt connect. Based on your location {location}, how can I help?',
                api_failed: 'API failed; using local logic with coordinates.',
            status_response: 'Im running smoothly! Ready to assist from your area.',
    status_check: ' You checked my status, so I confirmed my readiness.',
            uploaded: 'Uploaded',
            location_unknown: 'Location unknown. Please enable location services or provide your city/country. How can I assist?',
            where_am_i: 'I cannot determine your exact location without geolocation access. Please enable location services or provide your city/country.',
            located_near: 'Located near',
            coordinates: 'Coordinates: ({lat}, {lng})',
            how_can_i_help: 'How can I assist?',
            location_error: 'Unable to access location. Please enable location services or try again later.',
            login_error: 'Failed to load chat. Please check your connection or try again.',
            calendar_actions: 'Google Calendar',
            list_events: 'List Events',
            create_event: 'Create Event',
            find_free_time: 'Find Free Time',
            calendar_settings: 'Settings',
            event_title: 'Event Title',
            event_description: 'Description',
            start_time: 'Start Time',
            end_time: 'End Time',
            cancel: 'Cancel',
            your_events: 'Your Upcoming Events',
            start_date: 'Start Date',
            end_date: 'End Date',
            find_free_slots: 'Find Free Slots',
            available_slots: 'Available Time Slots',
            no_events: 'No upcoming events found.',
            event_created: 'Event created successfully!',
            free_time_found: 'Found free time slots:',
            calendar_error: 'Error accessing calendar. Please try again.'
    },
    ro: {
      welcome: 'Bun venit la NEURONEXIS AI',
              terms: 'Prin autentificare, sunteți de acord cu Termenii noștri.',
              try_without_login: 'Încearcă fără autentificare',
              chat_title: 'Chat NEURONEXIS',
              message_placeholder: 'Mesaj către NEURONEXIS...',
              disclaimer: 'NEURONEXIS poate produce informații inexacte',
              xai_mode: 'Mod XAI: Activat',
              xai_mode_off: 'Mod XAI: Dezactivat',
              settings: 'Setări',
              login: 'Autentificare',
              logout: 'Deconectare',
              instagram_placeholder: 'Nume Instagram',
              facebook_placeholder: 'Nume Facebook',
              upload_file: 'Încarcă fișier',
              document_editor: 'Editor de documente',
              download: 'Descarcă',
              guest_user: 'Utilizator invitat',
              logged_out: 'Ați fost deconectat.',
              explanation: 'Explicație',
              explanation_response: 'Răspuns creat pe baza inputului și locației tale.',
              connection_error: 'Îmi pare rău, nu m-am putut conecta. În funcție de locația ta {location}, ce mai pot face pentru tine?',
              api_failed: 'API a eșuat; folosesc logica locală cu coordonate.',
              status_response: 'Funcționez fără probleme! Gata să te ajut din zona ta.',
              status_check: ' Ai verificat starea mea, așa că am confirmat disponibilitatea.',
              uploaded: 'Încărcat',
              location_unknown: 'Locație necunoscută. Te rog să activezi serviciile de localizare sau să indici orașul/țara. Cum te pot ajuta?',
              where_am_i: 'Nu pot determina locația ta exactă fără acces la geolocalizare. Te rog să activezi serviciile de localizare sau să indici orașul/țara.',
              located_near: 'Situat în apropiere de',
              coordinates: 'Coordonate: ({lat}, {lng})',
              how_can_i_help: 'Cum te pot ajuta?',
              location_error: 'Nu pot accesa locația. Te rog să activezi serviciile de localizare sau să încerci din nou mai târziu.',
              login_error: 'Nu s-a putut încărca chatul. Verifică conexiunea sau încearcă din nou.',
              calendar_actions: 'Google Calendar',
              list_events: 'Listează Evenimente',
              create_event: 'Creează Eveniment',
              find_free_time: 'Găsește Timp Liber',
              calendar_settings: 'Setări',
              event_title: 'Titlu Eveniment',
              event_description: 'Descriere',
              start_time: 'Ora de început',
              end_time: 'Ora de sfârșit',
              cancel: 'Anulează',
              your_events: 'Evenimentele tale viitoare',
              start_date: 'Data de început',
              end_date: 'Data de sfârșit',
              find_free_slots: 'Găsește Intervale Libere',
              available_slots: 'Intervale de timp disponibile',
              no_events: 'Nu s-au găsit evenimente viitoare.',
              event_created: 'Eveniment creat cu succes!',
              free_time_found: 'Am găsit intervale de timp liber:',
              calendar_error: 'Eroare la accesarea calendarului. Te rog să încerci din nou.'
    },
    ru: {
      welcome: 'Добро пожаловать в NEURONEXIS AI',
              terms: 'Входя в систему, вы соглашаетесь с нашими Условиями.',
              try_without_login: 'Попробовать без входа',
              chat_title: 'Чат NEURONEXIS',
              message_placeholder: 'Сообщение для NEURONEXIS...',
              disclaimer: 'NEURONEXIS может предоставлять неточную информацию',
              xai_mode: 'Режим XAI: Включен',
              xai_mode_off: 'Режим XAI: Выключен',
              settings: 'Настройки',
              login: 'Войти',
              logout: 'Выйти',
              instagram_placeholder: 'Имя в Instagram',
              facebook_placeholder: 'Имя в Facebook',
              upload_file: 'Загрузить файл',
              document_editor: 'Редактор документов',
              download: 'Скачать',
              guest_user: 'Гость',
              logged_out: 'Вы вышли из системы.',
              explanation: 'Объяснение',
              explanation_response: 'Ответ сформирован на основе вашего ввода и местоположения.',
              connection_error: 'Извините, не удалось подключиться. Как могу помочь, учитывая ваше местоположение {location}?',
              api_failed: 'API не работает; использую локальную логику с координатами.',
              status_response: 'Я работаю без сбоев! Готов помочь из вашего региона.',
              status_check: ' Вы проверили мой статус, поэтому я подтвердил готовность.',
              uploaded: 'Загружено',
              location_unknown: 'Местоположение неизвестно. Пожалуйста, включите службы геолокации или укажите ваш город/страну. Как могу помочь?',
              where_am_i: 'Я не могу определить ваше точное местоположение без доступа к геолокации. Пожалуйста, включите службы геолокации или укажите ваш город/страну.',
              located_near: 'Находится рядом с',
              coordinates: 'Координаты: ({lat}, {lng})',
              how_can_i_help: 'Как могу помочь?',
              location_error: 'Не удалось получить доступ к местоположению. Пожалуйста, включите службы геолокации или попробуйте снова позже.',
              login_error: 'Не удалось загрузить чат. Проверьте подключение или попробуйте снова.',
              calendar_actions: 'Google Календарь',
              list_events: 'Список Событий',
              create_event: 'Создать Событие',
              find_free_time: 'Найти Свободное Время',
              calendar_settings: 'Настройки',
              event_title: 'Название События',
              event_description: 'Описание',
              start_time: 'Время Начала',
              end_time: 'Время Окончания',
              cancel: 'Отмена',
              your_events: 'Ваши Предстоящие События',
              start_date: 'Дата Начала',
              end_date: 'Дата Окончания',
              find_free_slots: 'Найти Свободные Промежутки',
              available_slots: 'Доступные Промежутки Времени',
              no_events: 'Предстоящих событий не найдено.',
              event_created: 'Событие успешно создано!',
              free_time_found: 'Найдены свободные промежутки времени:',
              calendar_error: 'Ошибка доступа к календарю. Пожалуйста, попробуйте снова.'
    },
    fr: {
      welcome: 'Bienvenue sur NEURONEXIS AI',
              terms: 'En vous connectant, vous acceptez nos conditions.',
              try_without_login: 'Essayer sans connexion',
              chat_title: 'Chat NEURONEXIS',
              message_placeholder: 'Message à NEURONEXIS...',
              disclaimer: 'NEURONEXIS peut produire des informations inexactes',
              xai_mode: 'Mode XAI : Activé',
              xai_mode_off: 'Mode XAI : Désactivé',
              settings: 'Paramètres',
              login: 'Connexion',
              logout: 'Déconnexion',
              instagram_placeholder: 'Identifiant Instagram',
              facebook_placeholder: 'Nom Facebook',
              upload_file: 'Télécharger un fichier',
              document_editor: 'Éditeur de documents',
              download: 'Télécharger',
              guest_user: 'Utilisateur invité',
              logged_out: 'Vous avez été déconnecté.',
              explanation: 'Explication',
              explanation_response: 'Réponse élaborée en fonction de votre saisie et de votre emplacement.',
              connection_error: 'Désolé, je nai pas pu me connecter. En fonction de votre emplacement {location}, comment puis-je vous aider ?',
              api_failed: 'LAPI a échoué ; jutilise une logique locale avec les coordonnées.',
              status_response: 'Je fonctionne parfaitement ! Prêt à vous aider depuis votre région.',
              status_check: ' Vous avez vérifié mon statut, jai donc confirmé ma disponibilité.',
      uploaded: 'Téléchargé',
              location_unknown: 'Emplacement inconnu. Veuillez activer les services de localisation ou indiquer votre ville/pays. Comment puis-je vous aider ?',
              where_am_i: 'Je ne peux pas déterminer votre emplacement exact sans accès à la géolocalisation. Veuillez activer les services de localisation ou indiquer votre ville/pays.',
              located_near: 'Situé près de',
              coordinates: 'Coordonnées : ({lat}, {lng})',
              how_can_i_help: 'Comment puis-je vous aider ?',
              location_error: 'Impossible daccéder à lemplacement. Veuillez activer les services de localisation ou réessayer plus tard.',
              login_error: 'Impossible de charger le chat. Vérifiez votre connexion ou réessayez.',
              calendar_actions: 'Google Agenda',
              list_events: 'Lister les Événements',
              create_event: 'Créer un Événement',
              find_free_time: 'Trouver du Temps Libre',
              calendar_settings: 'Paramètres',
              event_title: 'Titre de lÉvénement',
      event_description: 'Description',
              start_time: 'Heure de Début',
              end_time: 'Heure de Fin',
              cancel: 'Annuler',
              your_events: 'Vos Événements à Venir',
              start_date: 'Date de Début',
              end_date: 'Date de Fin',
              find_free_slots: 'Trouver des Créneaux Libres',
              available_slots: 'Créneaux Disponibles',
              no_events: 'Aucun événement à venir trouvé.',
              event_created: 'Événement créé avec succès !',
              free_time_found: 'Temps libre trouvé :',
              calendar_error: 'Erreur lors de laccès au calendrier. Veuillez réessayer.'
    }
    };

    document.addEventListener('DOMContentLoaded', () => {
      const chatBox = document.getElementById('chat-box');
      const userInput = document.getElementById('user-input');
      const sendBtn = document.getElementById('send-btn');
      const sidebar = document.getElementById('sidebar');
      const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
      const langSelect = document.getElementById('lang-select');
      const loginNav = document.getElementById('login-nav');
      const profileNav = document.getElementById('profile-nav');
      const profileBtn = document.getElementById('profile-btn');
      const userName = document.getElementById('user-name');
      const fileInput = document.getElementById('file-input');
      const documentModal = document.getElementById('document-modal');
      const documentContent = document.getElementById('document-content');
      const closeDocumentModal = document.getElementById('close-document-modal');
      const documentType = document.getElementById('document-type');
      const downloadDocument = document.getElementById('download-document');
      const xaiToggle = document.getElementById('xai-toggle');
      const instagramInput = document.getElementById('instagram');
      const facebookInput = document.getElementById('facebook');
      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const calendarModal = document.getElementById('calendar-modal');
      const closeCalendarModal = document.getElementById('close-calendar-modal');
      const calendarActions = document.getElementById('calendar-actions');
      const listEventsBtn = document.getElementById('list-events');
      const createEventBtn = document.getElementById('create-event');
      const findFreeTimeBtn = document.getElementById('find-free-time');
      const calendarSettingsBtn = document.getElementById('calendar-settings');
      const eventCreationForm = document.getElementById('event-creation-form');
      const eventsList = document.getElementById('events-list');
      const freeTimeFinder = document.getElementById('free-time-finder');
      const cancelEventBtn = document.getElementById('cancel-event');
      const submitEventBtn = document.getElementById('submit-event');
      const findFreeSlotsBtn = document.getElementById('find-free-slots');
      const eventsContainer = document.getElementById('events-container');
      const freeTimeContainer = document.getElementById('free-time-container');
      const freeTimeResults = document.getElementById('free-time-results');

      // Google API Initialization
      function gapiLoaded() {
        try {
          gapi.load('client', initializeGapiClient);
        } catch (error) {
          console.error('gapi.load failed:', error);
          gapiInited = true;
          maybeEnableApp();
        }
      }

      async function initializeGapiClient() {
        try {
          await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: [
              'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'
            ]
          });
          console.log('Google API initialized');
          gapiInited = true;
          maybeEnableApp();
        } catch (error) {
          console.error('Google API initialization error:', error);
          gapiInited = true;
          maybeEnableApp();
        }
      }

      function gisLoaded() {
        console.log('Google Sign-In script loaded');
        gisInited = true;
        maybeEnableApp();
      }

      function maybeEnableApp() {
        if (currentUser) {
          console.log('User detected, enabling app:', currentUser);
          document.getElementById('login-section').classList.add('hidden');
          document.getElementById('app-content').classList.remove('hidden');
          updateUI();
          loadUserData();
        } else {
          console.log('No user detected, showing login section');
          document.getElementById('login-section').classList.remove('hidden');
          document.getElementById('app-content').classList.add('hidden');
        }
      }

      window.gapiLoaded = gapiLoaded;
      window.gisLoaded = gisLoaded;

      function handleGoogleSignIn(response) {
        try {
          const userInfo = JSON.parse(atob(response.credential.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
          currentUser = userInfo.email;
          accessToken = response.credential;
          localStorage.setItem('currentUser', currentUser);
          localStorage.setItem('googleAccessToken', accessToken);
          userData[currentUser] = userData[currentUser] || { chats: {}, instagram: '', facebook: '' };
          localStorage.setItem('userData', JSON.stringify(userData));
          console.log('Google Sign-In successful:', currentUser);
          maybeEnableApp();
        } catch (error) {
          console.error('Google Sign-In error:', error);
          addMessage(translations[currentLanguage].login_error, 'ai');
        }
      }

      async function loadUserData() {
        const cachedLocation = JSON.parse(localStorage.getItem('userLocation'));
        if (cachedLocation && Date.now() - cachedLocation.timestamp < 3600000) {
          userLocation = cachedLocation.coords;
          userLocationName = cachedLocation.name || translations[currentLanguage].coordinates.replace('{lat}', userLocation.lat).replace('{lng}', userLocation.lng);
          console.log('Using cached location:', userLocationName, userLocation);
          addMessage(
                  `${translations[currentLanguage].welcome}! ${translations[currentLanguage].located_near} ${userLocationName}. ${translations[currentLanguage].how_can_i_help} ${instagram ? `Instagram: ${instagram}` : ''} ${facebook ? `Facebook: ${facebook}` : ''}`,
                  'ai'
          );
        } else if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
                  async (pos) => {
                    userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    console.log('Geolocation success:', userLocation);
                    try {
                      userLocationName = await fetchLocationNameWithRetry(userLocation);
                      console.log('Reverse geocoding success:', userLocationName);
                    } catch (error) {
                      console.warn('Reverse geocoding failed, using coordinates:', error);
                      userLocationName = translations[currentLanguage].coordinates.replace('{lat}', userLocation.lat).replace('{lng}', userLocation.lng);
                    }
                    localStorage.setItem('userLocation', JSON.stringify({
                      coords: userLocation,
                      name: userLocationName,
                      timestamp: Date.now()
                    }));
                    localStorage.setItem('userLocationName', userLocationName);
                    addMessage(
                            `${translations[currentLanguage].welcome}! ${translations[currentLanguage].located_near} ${userLocationName}. ${translations[currentLanguage].how_can_i_help} ${instagram ? `Instagram: ${instagram}` : ''} ${facebook ? `Facebook: ${facebook}` : ''}`,
                            'ai'
                    );
                  },
                  (err) => {
                    console.error('Geolocation error:', err.message, err.code);
                    userLocationName = 'Unknown';
                    localStorage.setItem('userLocationName', userLocationName);
                    addMessage(
                            `${translations[currentLanguage].welcome}! ${translations[currentLanguage].location_unknown} ${instagram ? `Instagram: ${instagram}` : ''} ${facebook ? `Facebook: ${facebook}` : ''}`,
                            'ai'
                    );
                  },
                  { timeout: 10000, maximumAge: 60000, enableHighAccuracy: true }
          );
        } else {
          console.warn('Geolocation not supported');
          userLocationName = 'Unknown';
          localStorage.setItem('userLocationName', userLocationName);
          addMessage(
                  `${translations[currentLanguage].welcome}! ${translations[currentLanguage].location_unknown} ${instagram ? `Instagram: ${instagram}` : ''} ${facebook ? `Facebook: ${facebook}` : ''}`,
                  'ai'
          );
        }
        if (userData[currentUser]) {
          instagram = userData[currentUser].instagram || '';
          facebook = userData[currentUser].facebook || '';
          instagramInput.value = instagram;
          facebookInput.value = facebook;
          userName.textContent = currentUser === 'guest@neuronexis.com' ? translations[currentLanguage].guest_user : (userData[currentUser]?.name || currentUser);
          chatHistory.forEach(msg => addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai'));
        }
        updateTranslations();
      }

      async function fetchLocationNameWithRetry(location, retries = 3, delay = 1000) {
        for (let i = 0; i < retries; i++) {
          try {
            const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${location.lat}&lon=${location.lng}&zoom=10&addressdetails=1`,
                    { headers: { 'User-Agent': 'NEURONEXIS_AI/1.0' } }
            );
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return data.display_name || translations[currentLanguage].coordinates.replace('{lat}', location.lat).replace('{lng}', location.lng);
          } catch (error) {
            console.warn(`Reverse geocoding attempt ${i + 1} failed:`, error);
            if (i < retries - 1) await new Promise(resolve => setTimeout(resolve, delay));
            else return translations[currentLanguage].coordinates.replace('{lat}', location.lat).replace('{lng}', location.lng);
          }
        }
      }

      function updateUI() {
        loginNav.classList.add('hidden');
        profileNav.classList.remove('hidden');
        userName.textContent = currentUser === 'guest@neuronexis.com' ? translations[currentLanguage].guest_user : (userData[currentUser]?.name || currentUser);
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('app-content').classList.remove('hidden');
        const avatar = document.createElement('div');
        avatar.className = 'w-8 h-8 rounded-full bg-cover bg-center';
        avatar.style.backgroundImage = `url(https://via.placeholder.com/150)`;
        document.querySelector('header').prepend(avatar);
        updateTranslations();
      }

      function updateTranslations() {
        document.querySelectorAll('[data-translate]').forEach(element => {
          const key = element.getAttribute('data-translate');
          if (translations[currentLanguage][key]) {
            element.textContent = translations[currentLanguage][key];
          }
        });
        document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
          const key = element.getAttribute('data-translate-placeholder');
          if (translations[currentLanguage][key]) {
            element.placeholder = translations[currentLanguage][key];
          }
        });
        xaiToggle.innerHTML = xaiMode
                ? `<i class="fas fa-brain"></i><span>${translations[currentLanguage].xai_mode}</span>`
                : `<i class="fas fa-brain"></i><span>${translations[currentLanguage].xai_mode_off}</span>`;
      }

      document.getElementById('try-without-login').addEventListener('click', () => {
        try {
          currentUser = 'guest@neuronexis.com';
          userData[currentUser] = userData[currentUser] || { chats: {}, instagram: '', facebook: '' };
          localStorage.setItem('currentUser', currentUser);
          localStorage.setItem('userData', JSON.stringify(userData));
          console.log('Try Without Login clicked, user set:', currentUser);
          maybeEnableApp();
        } catch (error) {
          console.error('Try Without Login error:', error);
          addMessage(translations[currentLanguage].login_error, 'ai');
        }
      });

      loginBtn.addEventListener('click', () => {
        try {
          google.accounts.id.prompt();
          console.log('Login button clicked, prompting Google Sign-In');
        } catch (error) {
          console.error('Google Sign-In prompt error:', error);
          addMessage(translations[currentLanguage].login_error, 'ai');
        }
      });

      logoutBtn.addEventListener('click', () => {
        currentUser = null;
        accessToken = null;
        localStorage.removeItem('currentUser');
        localStorage.removeItem('googleAccessToken');
        localStorage.removeItem('userLocation');
        localStorage.removeItem('userLocationName');
        loginNav.classList.remove('hidden');
        profileNav.classList.add('hidden');
        chatBox.innerHTML = '';
        document.getElementById('login-section').classList.remove('hidden');
        document.getElementById('app-content').classList.add('hidden');
        addMessage(translations[currentLanguage].logged_out, 'ai');
      });

      document.getElementById('theme-toggle').addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
      });

      if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      }

      toggleSidebarBtn.addEventListener('click', () => {
        sidebar.classList.toggle('translate-x-full');
        sidebar.classList.toggle('translate-x-0');
      });

      profileBtn.addEventListener('click', () => {
        sidebar.classList.toggle('translate-x-full');
        sidebar.classList.toggle('translate-x-0');
      });

      langSelect.addEventListener('change', e => {
        currentLanguage = e.target.value;
        localStorage.setItem('language', currentLanguage);
        updateTranslations();
      });

      userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
      });

      userInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      sendBtn.addEventListener('click', sendMessage);

      xaiToggle.addEventListener('click', () => {
        xaiMode = !xaiMode;
        xaiToggle.innerHTML = xaiMode
                ? `<i class="fas fa-brain"></i><span>${translations[currentLanguage].xai_mode}</span>`
                : `<i class="fas fa-brain"></i><span>${translations[currentLanguage].xai_mode_off}</span>`;
        xaiToggle.classList.toggle('bg-purple-100', xaiMode);
        xaiToggle.classList.toggle('dark:bg-purple-900', xaiMode);
        xaiToggle.classList.toggle('bg-gray-200', !xaiMode);
        xaiToggle.classList.toggle('dark:bg-gray-700', !xaiMode);
      });

      instagramInput.addEventListener('change', e => {
        instagram = e.target.value;
        userData[currentUser].instagram = instagram;
        localStorage.setItem('userData', JSON.stringify(userData));
      });

      facebookInput.addEventListener('change', e => {
        facebook = e.target.value;
        userData[currentUser].facebook = facebook;
        localStorage.setItem('userData', JSON.stringify(userData));
      });

      function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        addMessage(message, 'user');
        userInput.value = '';
        userInput.style.height = 'auto';

        showTypingIndicator();

        setTimeout(async () => {
          removeTypingIndicator();
          const aiResponse = await generateAIResponse(message);
          addMessage(aiResponse.response, 'ai');
          if (xaiMode && aiResponse.explanation) {
            setTimeout(() => addMessage(aiResponse.explanation, 'ai', true), 500);
          }
          chatHistory.push({ role: 'user', content: message, timestamp: new Date().toISOString() });
          chatHistory.push({ role: 'ai', content: aiResponse.response, timestamp: new Date().toISOString() });
          userData[currentUser] = userData[currentUser] || { chats: {}, instagram, facebook };
          userData[currentUser].chats[currentDialog] = chatHistory;
          localStorage.setItem('userData', JSON.stringify(userData));
        }, 1500 + Math.random() * 2000);
      }

      function addMessage(text, sender, isExplanation = false) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('flex', 'message-animation');
        if (sender === 'user') {
          messageDiv.classList.add('justify-end');
          messageDiv.innerHTML = `<div class="max-w-[80%] bg-purple-600 text-white rounded-lg p-3 shadow-md"><p>${text}</p></div>`;
        } else {
          messageDiv.classList.add('justify-start');
          messageDiv.innerHTML = isExplanation
                  ? `
              <div class="max-w-[80%] bg-gray-100 dark:bg-gray-700 rounded-lg p-3 shadow-md xai-explanation">
                <div class="flex items-start space-x-2">
                  <div class="w-6 h-6 rounded-full bg-gradient-to-r from-purple-500 to-blue-400 mt-1 flex items-center justify-center text-white text-xs">N</div>
                  <div><p class="font-semibold text-purple-600 dark:text-purple-400" data-translate="explanation">${translations[currentLanguage].explanation}</p><p>${text}</p></div>
                </div>
              </div>`
                  : `
              <div class="max-w-[80%] bg-gray-100 dark:bg-gray-700 rounded-lg p-3 shadow-md">
                <div class="flex items-start space-x-2">
                  <div class="w-6 h-6 rounded-full bg-gradient-to-r from-purple-500 to-blue-400 mt-1"></div>
                  <div><p class="font-semibold">NEURONEXIS AI</p><p>${text}</p></div>
                </div>
              </div>`;
        }
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.classList.add('flex', 'justify-start');
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = `
          <div class="max-w-[80%] bg-gray-100 dark:bg-gray-700 rounded-lg p-2 shadow-md">
            <div class="flex items-center space-x-2 pl-2">
              <div class="w-6 h-6 rounded-full bg-gradient-to-r from-purple-500 to-blue-400"></div>
              <div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>
            </div>
          </div>`;
        chatBox.appendChild(typingDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function removeTypingIndicator() {
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) typingIndicator.remove();
      }

      async function generateAIResponse(userMessage) {
        const locationQueries = {
          en: ['where am i', 'my location', 'where i am'],
          ro: ['unde ma aflu', 'locația mea', 'unde sunt'],
          ru: ['где я нахожусь', 'мое местоположение', 'где я'],
          fr: ['où suis-je', 'mon emplacement', 'où je suis']
        };
        const isLocationQuery = Object.values(locationQueries).flat().some(query => userMessage.toLowerCase().includes(query));

        if (isLocationQuery) {
          if (userLocation) {
            try {
              userLocationName = await fetchLocationNameWithRetry(userLocation);
              console.log('Location query success:', userLocationName);
              localStorage.setItem('userLocation', JSON.stringify({
                coords: userLocation,
                name: userLocationName,
                timestamp: Date.now()
              }));
              localStorage.setItem('userLocationName', userLocationName);
              return {
                response: `${translations[currentLanguage].located_near} ${userLocationName}. ${translations[currentLanguage].how_can_i_help} ${instagram ? `Instagram: ${instagram}` : ''} ${facebook ? `Facebook: ${facebook}` : ''}`,
                explanation: translations[currentLanguage].explanation_response
              };
            } catch (error) {
              console.warn('Location query failed:', error);
              userLocationName = translations[currentLanguage].coordinates.replace('{lat}', userLocation.lat).replace('{lng}', userLocation.lng);
              localStorage.setItem('userLocationName', userLocationName);
              return {
                response: `${translations[currentLanguage].where_am_i} ${translations[currentLanguage].coordinates.replace('{lat}', userLocation.lat).replace('{lng}', userLocation.lng)}.`,
                explanation: translations[currentLanguage].api_failed
              };
            }
          } else {
            return {
              response: translations[currentLanguage].where_am_i,
              explanation: translations[currentLanguage].location_error
            };
          }
        }

        const statusQueries = {
          en: ['how are you', 'how you doing'],
          ro: ['ce mai faci', 'ce mai faci tu'],
          ru: ['как дела', 'как ты'],
          fr: ['comment vas-tu', 'ça va']
        };
        const isStatusQuery = Object.values(statusQueries).flat().some(query => userMessage.toLowerCase().includes(query));

        try {
          const response = await fetch('https://api.x.ai/v1/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${XAI_API_KEY}` },
            body: JSON.stringify({
              model: 'grok-3',
              messages: [
                {
                  role: 'system',
                  content: `You are NEURONEXIS AI. Language: ${currentLanguage}. Use location: ${userLocation ? translations[currentLanguage].coordinates.replace('{lat}', userLocation.lat).replace('{lng}', userLocation.lng) : userLocationName}. Include Instagram: ${instagram}, Facebook: ${facebook} in responses if relevant.`
                },
                { role: 'user', content: userMessage }
              ],
              temperature: 0.7,
              max_tokens: 4000
            })
          });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          const fullResponse = data.choices[0].message.content;
          let explanation = xaiMode ? translations[currentLanguage].explanation_response : '';
          return { response: fullResponse, explanation };
        } catch (error) {
          console.error('xAI API Error:', error);
          let response = translations[currentLanguage].connection_error.replace('{location}', userLocation ? translations[currentLanguage].coordinates.replace('{lat}', userLocation.lat).replace('{lng}', userLocation.lng) : userLocationName);
          let explanation = translations[currentLanguage].api_failed;
          if (isStatusQuery) {
            response = translations[currentLanguage].status_response;
            explanation += translations[currentLanguage].status_check;
          }
          return { response, explanation };
        }
      }

      document.getElementById('document-creation').addEventListener('click', () => {
        documentModal.classList.remove('hidden');
        documentContent.textContent = `Location: ${userLocationName}\nCoordinates: ${userLocation ? `(${userLocation.lat}, ${userLocation.lng})` : 'Unknown'}\nInstagram: ${instagram}\nFacebook: ${facebook}\n\nAdd your message here...`;
      });

      closeDocumentModal.addEventListener('click', () => documentModal.classList.add('hidden'));

      downloadDocument.addEventListener('click', () => {
        const content = documentContent.textContent;
        const type = documentType.value;
        const blob = new Blob([content], { type: type === 'docx' ? 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' : type === 'pdf' ? 'application/pdf' : 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `document.${type}`;
        a.click();
        URL.revokeObjectURL(url);
        documentModal.classList.add('hidden');
      });

      fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = event => addMessage(`${translations[currentLanguage].uploaded}: ${event.target.result.substring(0, 100)}${event.target.result.length > 100 ? '...' : ''}`, 'ai');
          reader.readAsText(file);
        }
      });

      const dialogSelect = document.getElementById('dialog-select');
      dialogSelect.addEventListener('change', e => {
        currentDialog = e.target.value;
        localStorage.setItem('currentDialog', currentDialog);
        chatHistory = userData[currentUser]?.chats?.[currentDialog] || [];
        chatBox.innerHTML = '';
        chatHistory.forEach(msg => addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai'));
      });

      // Calendar Functions
      calendarActions.addEventListener('click', () => {
        if (!currentUser || currentUser === 'guest@neuronexis.com') {
          addMessage(translations[currentLanguage].login_error, 'ai');
          return;
        }
        calendarModal.classList.remove('hidden');
        resetCalendarUI();
      });

      closeCalendarModal.addEventListener('click', () => {
        calendarModal.classList.add('hidden');
        resetCalendarUI();
      });

      function resetCalendarUI() {
        eventCreationForm.classList.add('hidden');
        eventsList.classList.add('hidden');
        freeTimeFinder.classList.add('hidden');
        freeTimeResults.classList.add('hidden');
      }

      listEventsBtn.addEventListener('click', async () => {
        resetCalendarUI();
        eventsList.classList.remove('hidden');
        eventsContainer.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i></div>';

        try {
          const response = await gapi.client.calendar.events.list({
            'calendarId': 'primary',
            'timeMin': (new Date()).toISOString(),
            'showDeleted': false,
            'singleEvents': true,
            'maxResults': 10,
            'orderBy': 'startTime'
          });

          const events = response.result.items;
          if (events.length > 0) {
            eventsContainer.innerHTML = '';
            events.forEach(event => {
              const start = event.start.dateTime || event.start.date;
              const end = event.end.dateTime || event.end.date;
              const eventDiv = document.createElement('div');
              eventDiv.className = 'event-card bg-white dark:bg-gray-700 p-3 rounded-lg shadow cursor-pointer';
              eventDiv.innerHTML = `
                <h4 class="font-semibold">${event.summary || 'No title'}</h4>
                <p class="text-sm text-gray-600 dark:text-gray-300">${new Date(start).toLocaleString()} - ${new Date(end).toLocaleString()}</p>
                ${event.description ? `<p class="text-sm mt-1">${event.description.substring(0, 100)}${event.description.length > 100 ? '...' : ''}</p>` : ''}
              `;
              eventsContainer.appendChild(eventDiv);
            });
          } else {
            eventsContainer.innerHTML = `<div class="text-center py-4 text-gray-500">${translations[currentLanguage].no_events}</div>`;
          }
        } catch (error) {
          console.error('Error listing events:', error);
          eventsContainer.innerHTML = `<div class="text-center py-4 text-red-500">${translations[currentLanguage].calendar_error}</div>`;
        }
      });

      createEventBtn.addEventListener('click', () => {
        resetCalendarUI();
        eventCreationForm.classList.remove('hidden');

        // Set default times (now and 1 hour from now)
        const now = new Date();
        const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);

        document.getElementById('event-start').value = formatDateTimeLocal(now);
        document.getElementById('event-end').value = formatDateTimeLocal(oneHourLater);
      });

      function formatDateTimeLocal(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');

        return `${year}-${month}-${day}T${hours}:${minutes}`;
      }

      cancelEventBtn.addEventListener('click', () => {
        resetCalendarUI();
      });

      submitEventBtn.addEventListener('click', async () => {
        const title = document.getElementById('event-title').value.trim();
        const description = document.getElementById('event-description').value.trim();
        const start = document.getElementById('event-start').value;
        const end = document.getElementById('event-end').value;

        if (!title) {
          alert(translations[currentLanguage].event_title + ' is required');
          return;
        }

        try {
          const event = {
            'summary': title,
            'description': description,
            'start': {
              'dateTime': start,
              'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone
            },
            'end': {
              'dateTime': end,
              'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone
            }
          };

          const response = await gapi.client.calendar.events.insert({
            'calendarId': 'primary',
            'resource': event
          });

          addMessage(translations[currentLanguage].event_created, 'ai');
          calendarModal.classList.add('hidden');
          resetCalendarUI();
        } catch (error) {
          console.error('Error creating event:', error);
          eventsContainer.innerHTML = `<div class="text-center py-4 text-red-500">${translations[currentLanguage].calendar_error}</div>`;
        }
      });

      findFreeTimeBtn.addEventListener('click', () => {
        resetCalendarUI();
        freeTimeFinder.classList.remove('hidden');

        // Set default dates (today and tomorrow)
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        document.getElementById('free-time-start').value = formatDate(today);
        document.getElementById('free-time-end').value = formatDate(tomorrow);
      });

      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');

        return `${year}-${month}-${day}`;
      }

      findFreeSlotsBtn.addEventListener('click', async () => {
        const startDate = document.getElementById('free-time-start').value;
        const endDate = document.getElementById('free-time-end').value;

        if (!startDate || !endDate) {
          alert('Please select both start and end dates');
          return;
        }

        freeTimeContainer.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i></div>';

        try {
          const timeMin = new Date(startDate + 'T00:00:00');
          const timeMax = new Date(endDate + 'T23:59:59');

          const response = await gapi.client.calendar.freebusy.query({
            'timeMin': timeMin.toISOString(),
            'timeMax': timeMax.toISOString(),
            'items': [{ 'id': 'primary' }]
          });

          const busySlots = response.result.calendars.primary.busy || [];
          const freeSlots = findFreeTimeSlots(timeMin, timeMax, busySlots);

          if (freeSlots.length > 0) {
            freeTimeContainer.innerHTML = '';
            freeSlots.forEach(slot => {
              const slotDiv = document.createElement('div');
              slotDiv.className = 'event-card bg-white dark:bg-gray-700 p-3 rounded-lg shadow';
              slotDiv.innerHTML = `
                <p class="font-semibold">${new Date(slot.start).toLocaleString()} - ${new Date(slot.end).toLocaleString()}</p>
                <p class="text-sm text-gray-600 dark:text-gray-300">${Math.round((slot.end - slot.start) / (60 * 60 * 1000) * 10) / 10} hours available</p>
              `;
              freeTimeContainer.appendChild(slotDiv);
            });
            freeTimeResults.classList.remove('hidden');
          } else {
            freeTimeContainer.innerHTML = `<div class="text-center py-4 text-gray-500">${translations[currentLanguage].no_events}</div>`;
            freeTimeResults.classList.remove('hidden');
          }
        } catch (error) {
          console.error('Error finding free time:', error);
          freeTimeContainer.innerHTML = `<div class="text-center py-4 text-red-500">${translations[currentLanguage].calendar_error}</div>`;
        }
      });

      function findFreeTimeSlots(timeMin, timeMax, busySlots) {
        const freeSlots = [];
        let currentTime = new Date(timeMin);

        // Sort busy slots by start time
        busySlots.sort((a, b) => new Date(a.start) - new Date(b.start));

        for (const busy of busySlots) {
          const busyStart = new Date(busy.start);
          const busyEnd = new Date(busy.end);

          if (busyStart > currentTime) {
            freeSlots.push({
              start: new Date(currentTime),
              end: new Date(busyStart)
            });
          }

          if (busyEnd > currentTime) {
            currentTime = new Date(busyEnd);
          }
        }

        // Add remaining free time after last busy slot
        if (currentTime < timeMax) {
          freeSlots.push({
            start: new Date(currentTime),
            end: new Date(timeMax)
          });
        }

        return freeSlots.filter(slot => (slot.end - slot.start) > 0);
      }

      calendarSettingsBtn.addEventListener('click', () => {
        addMessage("Calendar settings would be displayed here. This is a demo interface.", 'ai');
      });

      // Initialize app if user exists
      if (currentUser) {
        console.log('Initial user check:', currentUser);
        maybeEnableApp();
      }

      // Timeout for Google API initialization to prevent indefinite wait
      setTimeout(() => {
        if (!gapiInited || !gisInited) {
          console.warn('Google API initialization timed out, proceeding with app');
          gapiInited = true;
          gisInited = true;
          maybeEnableApp();
        }
      }, 10000); // 10-second timeout
    });
  </script>
</body>
</html>